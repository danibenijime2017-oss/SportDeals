<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SportDeals | Ofertas fitness</title>
  <style>
    :root{--bg:#0b0b0c;--card:#141416;--muted:#8a8f98;--text:#f5f6f8;--brand:#6ee7b7;--accent:#60a5fa}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{position:sticky;top:0;background:linear-gradient(0deg,transparent,rgba(10,10,12,.9) 40%);backdrop-filter: blur(8px);z-index:10;border-bottom:1px solid #191b1f}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:grid;grid-template-columns:1fr 160px 180px;gap:10px;align-items:center}
    .brand{font-weight:800;font-size:22px;letter-spacing:.2px}
    input,select{background:#0f1012;color:var(--text);border:1px solid #222;outline:none;border-radius:10px;padding:10px 12px}
    main{padding:18px 0 60px}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:960px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid #1f2125;border-radius:18px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;object-fit:cover;width:100%;background:#0f1012}
    .content{padding:14px}
    .title{font-weight:700;line-height:1.2;margin:4px 0 8px;font-size:15px}
    .bullets{color:var(--muted);font-size:13px;line-height:1.45;margin:0 0 10px;min-height:48px}
    .price{display:flex;gap:8px;align-items:baseline;margin:8px 0 12px}
    .before{text-decoration:line-through;color:#a1a1aa;font-size:13px}
    .now{font-weight:800;color:var(--brand);font-size:18px}
    .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#a9b0ba}
    .tag{background:#0f1012;border:1px solid #202327;border-radius:999px;padding:6px 10px;font-size:12px}
    .cta{display:inline-block;text-align:center;background:var(--accent);color:#06121f;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;text-decoration:none}
    footer{color:#7d8490;font-size:12px;text-align:center;padding:30px 0;border-top:1px solid #191b1f}
    .empty{opacity:.7;text-align:center;padding:40px 10px}
    #status{max-width:1100px;margin:8px auto 0;padding:0 16px;color:#9bb1ff;font-size:13px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">üè∑Ô∏è SportDeals</div>
    <div class="toolbar" style="margin-top:10px">
      <input id="q" placeholder="Buscar (t√≠tulo, bullets, etiquetas)..." />
      <select id="cat"><option value="">Todas</option></select>
      <select id="sort">
        <option value="fecha-desc" selected>M√°s recientes</option>
        <option value="precio-asc">Precio ahora ‚Üë</option>
        <option value="precio-desc">Precio ahora ‚Üì</option>
        <option value="descuento-desc">Descuento % ‚Üì</option>
      </select>
    </div>
  </div>
</header>

<div id="status" class="wrap">Cargando datos‚Ä¶</div>

<main class="wrap">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">No hay resultados.</div>
</main>

<footer>¬© SportDeals ¬∑ Enlaces de afiliado (#ad)</footer>

<script>
/* üîó Tu hoja publicada como HTML (pubhtml) */
const SHEET_HTML = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT1KsfcN4AUSWQOzFBdhzbmswKeDvQ4YQji_0uCYMMo7IBAchfKb8l6cGEfe-a6GZJzJmJqa_3Q1lyo/pubhtml";

let DATA = [];

function pct(before, now){
  const b=parseFloat(String(before||"").replace(",", "."));
  const n=parseFloat(String(now||"").replace(",", "."));
  if(!isFinite(b)||!isFinite(n)||b<=0) return null;
  return Math.round((1 - n/b)*100);
}

async function load(){
  const status = document.getElementById('status');
  try{
    const t0 = Date.now();
    const res = await fetch(SHEET_HTML, {cache:"no-store"});
    const html = await res.text();

    // Parsear el HTML de Google Sheets (tabla principal)
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    const table = doc.querySelector("table");
    if(!table){ throw new Error("No se encontr√≥ tabla en pubhtml"); }

    const headers = [...table.querySelectorAll("thead tr th")].map(th => th.innerText.trim());
    const rowsEls = [...table.querySelectorAll("tbody tr")];

    DATA = rowsEls.map(tr=>{
      const tds=[...tr.querySelectorAll("td")];
      const obj={};
      headers.forEach((h,i)=> obj[h] = tds[i] ? tds[i].innerText.trim() : "");
      return obj;
    });

    const visibles = DATA.filter(r => (r.Estado||"").toLowerCase().trim()==="listo");
    const ms = Date.now()-t0;
    status.textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString()} ¬∑ Filas totales: ${DATA.length} ¬∑ Publicadas: ${visibles.length} ¬∑ ${ms} ms`;

    render();
  }catch(e){
    console.error("[SportDeals] Error:", e);
    status.textContent = "Error cargando la hoja publicada (pubhtml). Revisa el enlace.";
    document.getElementById("grid").innerHTML = "<div class='empty'>Error al cargar datos.</div>";
  }
}

function render(){
  const q=(document.getElementById('q').value||"").toLowerCase().trim();
  const catSel=document.getElementById('cat').value;
  const sort=document.getElementById('sort').value;

  // Poblar categor√≠as
  const cats = [...new Set(DATA.map(r=>(r.Categoria||"").trim()).filter(Boolean))].sort();
  const catEl = document.getElementById('cat');
  catEl.innerHTML = '<option value="">Todas</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join("");

  let rows = DATA.filter(r => (r.Estado||"").toLowerCase().trim()==="listo");

  if(catSel) rows = rows.filter(r => (r.Categoria||"").toLowerCase().trim()===catSel.toLowerCase().trim());
  if(q) rows = rows.filter(r => `${r.Titulo||""} ${r.Bullets||""} ${r.Etiquetas||""}`.toLowerCase().includes(q));

  // üîΩ Orden por defecto: m√°s recientes (FechaHora descendente)
  if(sort==="fecha-desc"){
    rows.sort((a,b)=> new Date(b.FechaHora||0) - new Date(a.FechaHora||0));
  }else if(sort==="precio-asc"){
    rows.sort((a,b)=> (parseFloat(String(a.Precio_Ahora||"").replace(",", "."))||9e9) - (parseFloat(String(b.Precio_Ahora||"").replace(",", "."))||9e9));
  }else if(sort==="precio-desc"){
    rows.sort((a,b)=> (parseFloat(String(b.Precio_Ahora||"").replace(",", "."))||-9e9) - (parseFloat(String(a.Precio_Ahora||"").replace(",", "."))||-9e9));
  }else if(sort==="descuento-desc"){
    const disc = r => pct(r.Precio_Antes, r.Precio_Ahora);
    rows.sort((a,b)=> (disc(b)??-999) - (disc(a)??-999));
  }

  const grid=document.getElementById("grid");
  grid.innerHTML="";

  rows.forEach(r=>{
    const p=pct(r.Precio_Antes, r.Precio_Ahora);
    const utm="?utm_source=web&utm_medium=affiliate&utm_campaign=sportdeals";
    const link=(r.Enlace||"").includes("?")?`${r.Enlace}&${utm.slice(1)}`:`${r.Enlace}${utm}`;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
<img class="thumb" src="${r.Imagen||''}" alt="${r.Titulo||'Producto'}"
     onerror="this.src='https://via.placeholder.com/300x225/0f1012/384150?text=Sin+imagen';" />

      <div class="content">
        <div class="title">${r.Titulo||""}</div>
        <div class="bullets">${(r.Bullets||"").split(/;|\n|‚Ä¢/).map(s=>s.trim()).filter(Boolean).map(b=>`‚Ä¢ ${b}`).join("<br>")}</div>
        <div class="price">
          ${r.Precio_Antes?`<span class="before">${r.Precio_Antes}</span>`:""}
          ${r.Precio_Ahora?`<span class="now">${r.Precio_Ahora}${p!==null?` <span style="color:#a7f3d0;font-weight:700">(-${p}%)</span>`:""}</span>`:""}
        </div>
        <div class="meta">
          <span class="tag">${(r.Categoria||"").toUpperCase()}</span>
          <span style="color:#a9b0ba;font-size:12px">${(r.Etiquetas||"").split(/[#\s]+/).filter(Boolean).slice(0,4).map(t=>"#"+t).join(" ")}</span>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;padding:0 14px 14px">
        <a class="cta" href="${link}" target="_blank" rel="sponsored nofollow noopener">Ver oferta</a>
        <a class="cta" style="background:#22d3ee" href="${r.Enlace||'#'}" target="_blank" rel="sponsored nofollow noopener">Link limpio</a>
      </div>
    `;
    grid.appendChild(card);
  });

  document.getElementById("empty").style.display = rows.length ? "none" : "block";
}

// UI events
document.getElementById('q').addEventListener('input', render);
document.getElementById('cat').addEventListener('change', render);
document.getElementById('sort').addEventListener('change', render);

// ‚è±Ô∏è Auto-refresco cada 5 minutos
setInterval(load, 5 * 60 * 1000);

// Primera carga
load();
</script>
</body>
</html>


