<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SportDeals | Ofertas fitness</title>
  <style>
    :root{--bg:#0b0b0c;--card:#141416;--muted:#8a8f98;--text:#f5f6f8;--brand:#6ee7b7;--accent:#60a5fa}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{position:sticky;top:0;background:linear-gradient(0deg,transparent,rgba(10,10,12,.9) 40%);backdrop-filter: blur(8px);z-index:10;border-bottom:1px solid #191b1f}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:grid;grid-template-columns:1fr 160px 180px;gap:10px;align-items:center}
    .brand{font-weight:800;font-size:22px;letter-spacing:.2px}
    input,select{background:#0f1012;color:var(--text);border:1px solid #222;outline:none;border-radius:10px;padding:10px 12px}
    main{padding:18px 0 60px}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:960px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid #1f2125;border-radius:18px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;object-fit:cover;width:100%;background:#0f1012}
    .content{padding:14px}
    .title{font-weight:700;line-height:1.2;margin:4px 0 8px;font-size:15px}
    .bullets{color:var(--muted);font-size:13px;line-height:1.45;margin:0 0 10px;min-height:48px}
    .price{display:flex;gap:8px;align-items:baseline;margin:8px 0 12px}
    .before{text-decoration:line-through;color:#a1a1aa;font-size:13px}
    .now{font-weight:800;color:var(--brand);font-size:18px}
    .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#a9b0ba}
    .tag{background:#0f1012;border:1px solid #202327;border-radius:999px;padding:6px 10px;font-size:12px}
    .cta{display:inline-block;text-align:center;background:var(--accent);color:#06121f;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;text-decoration:none}
    footer{color:#7d8490;font-size:12px;text-align:center;padding:30px 0;border-top:1px solid #191b1f}
    .empty{opacity:.7;text-align:center;padding:40px 10px}
    #status{max-width:1100px;margin:8px auto 0;padding:0 16px;color:#9bb1ff;font-size:13px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">üè∑Ô∏è SportDeals</div>
    <div class="toolbar" style="margin-top:10px">
      <input id="q" placeholder="Buscar (t√≠tulo, bullets, etiquetas)..." />
      <select id="cat"><option value="">Todas</option></select>
      <select id="sort">
        <option value="fecha-desc" selected>M√°s recientes</option>
        <option value="precio-asc">Precio ahora ‚Üë</option>
        <option value="precio-desc">Precio ahora ‚Üì</option>
        <option value="descuento-desc">Descuento % ‚Üì</option>
      </select>
    </div>
  </div>
</header>

<div id="status" class="wrap">Cargando datos‚Ä¶</div>

<main class="wrap">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">No hay resultados.</div>
</main>

<footer>¬© SportDeals ¬∑ Enlaces de afiliado (#ad)</footer>

<script>
/* üîó GViz JSON (ID real /d/... y gid correcto de tu pesta√±a) */
const GVIZ_JSON = "https://docs.google.com/spreadsheets/d/1WUaHmN1zRvdPho4NQ_DTXmi-Sn8BH0iFJi395yAx_vU/gviz/tq?gid=1588859322&tqx=out:json";

/* ‚úÖ Fallback inline para im√°genes rotas */
const FALLBACK_IMG =
  "data:image/svg+xml;base64," +
  btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 225"><rect width="100%" height="100%" fill="#0f1012"/><text x="50%" y="50%" fill="#384150" font-size="16" text-anchor="middle" dominant-baseline="middle">Sin imagen</text></svg>');

/* Limpia URLs: sin saltos de l√≠nea, sin espacios; asegura https://; normaliza path */
function cleanUrl(u){
  if(!u) return "";
  u = String(u).replace(/\r?\n/g,"").trim().replace(/\s+/g,"");
  if(!/^https?:\/\//i.test(u)) u = "https://" + u;
  try{
    const url = new URL(u);
    url.pathname = encodeURI(decodeURI(url.pathname));
    return url.toString();
  }catch{ return u; }
}

/* Obtiene un campo aunque el encabezado tenga espacios/may√∫sculas distintos */
function getField(row, name){
  if (row[name] != null && row[name] !== "") return row[name];
  const target = name.toLowerCase().trim().replace(/\s+/g,"");
  for (const k of Object.keys(row)){
    const norm = k.toLowerCase().trim().replace(/\s+/g,"");
    if (norm === target) return row[k] ?? "";
  }
  return "";
}

let DATA = [];

/* Utilidades */
function pct(before, now) {
  const b = parseFloat(String(before ?? "").toString().replace(",", "."));
  const n = parseFloat(String(now ?? "").toString().replace(",", "."));
  if (!isFinite(b) || !isFinite(n) || b <= 0) return null;
  return Math.round((1 - n / b) * 100);
}

/* Parsear GViz JSON */
function parseGviz(jsonText) {
  const start = jsonText.indexOf("{");
  const end = jsonText.lastIndexOf("}");
  if (start === -1 || end === -1) throw new Error("GViz JSON inv√°lido");
  const obj = JSON.parse(jsonText.slice(start, end + 1));
  const table = obj.table;
  if (!table || !table.cols || !table.rows) throw new Error("GViz sin tabla");

  const labels = table.cols.map(c => (c.label || "").trim());
  const rows = table.rows.map(r => {
    const o = {};
    r.c.forEach((cell, i) => {
      const key = labels[i] || ("Col" + i);
      let v = cell ? (cell.f ?? cell.v) : "";
      if (v && typeof v === "object" && v !== null) v = v.v ?? "";
      if (typeof v === "string") v = v.trim();
      o[key] = v ?? "";
    });
    return o;
  });
  return rows;
}

/* Carga datos */
async function load() {
  const status = document.getElementById("status");
  const t0 = Date.now();
  try {
    const res = await fetch(GVIZ_JSON, { cache: "no-store" });
    const txt = await res.text();
    DATA = parseGviz(txt) || [];

    const visibles = DATA.filter(r => (String(getField(r,"Estado") || "").toLowerCase().trim() === "listo"));
    const ms = Date.now() - t0;
    status.textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString()} ¬∑ Filas totales: ${DATA.length} ¬∑ Publicadas: ${visibles.length} ¬∑ ${ms} ms`;

    render();
  } catch (e) {
    console.error("[SportDeals] Error en load():", e);
    status.textContent = "Error cargando GViz. Revisa que la hoja est√© publicada y que el gid sea correcto.";
    document.getElementById("grid").innerHTML = "<div class='empty'>Error al cargar datos.</div>";
  }
}

/* Pintar tarjetas */
function render() {
  const q = (document.getElementById("q").value || "").toLowerCase().trim();
  const catSel = document.getElementById("cat").value;
  const sort = document.getElementById("sort").value;

  // Poblar categor√≠as
  const cats = [...new Set(DATA.map(r => (getField(r,"Categoria") || "").trim()).filter(Boolean))].sort();
  const catEl = document.getElementById("cat");
  catEl.innerHTML = '<option value="">Todas</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join("");

  // Filtrar
  let rows = DATA.filter(r => (String(getField(r,"Estado") || "").toLowerCase().trim() === "listo"));
  if (catSel) rows = rows.filter(r => (String(getField(r,"Categoria") || "").toLowerCase().trim() === catSel.toLowerCase().trim()));
  if (q) rows = rows.filter(r => `${getField(r,"Titulo") || ""} ${getField(r,"Bullets") || ""} ${getField(r,"Etiquetas") || ""}`.toLowerCase().includes(q));

  // Orden por defecto: m√°s recientes por FechaHora (desc)
  if (sort === "fecha-desc") {
    rows.sort((a, b) => new Date(getField(b,"FechaHora") || 0) - new Date(getField(a,"FechaHora") || 0));
  } else if (sort === "precio-asc") {
    const toNum = v => (parseFloat(String(v || "").replace(",", ".")) || 9e9);
    rows.sort((a, b) => toNum(getField(a,"Precio_Ahora")) - toNum(getField(b,"Precio_Ahora")));
  } else if (sort === "precio-desc") {
    const toNum = v => (parseFloat(String(v || "").replace(",", ".")) || -9e9);
    rows.sort((a, b) => toNum(getField(b,"Precio_Ahora")) - toNum(getField(a,"Precio_Ahora")));
  } else if (sort === "descuento-desc") {
    const disc = r => pct(getField(r,"Precio_Antes"), getField(r,"Precio_Ahora"));
    rows.sort((a, b) => (disc(b) ?? -999) - (disc(a) ?? -999));
  }

  // Pintar
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  rows.forEach(r => {
    const titulo = getField(r,"Titulo") || "";
    const bulletsTxt = getField(r,"Bullets") || "";
    const imgUrl = cleanUrl(getField(r,"Imagen"));
    const enlace = cleanUrl(getField(r,"Enlace"));   // ‚Üê ‚Üê el bot√≥n usar√° este enlace tal cual
    const precioAntes = getField(r,"Precio_Antes");
    const precioAhora = getField(r,"Precio_Ahora");
    const categoria = getField(r,"Categoria") || "";
    const etiquetas = getField(r,"Etiquetas") || "";
    const p = pct(precioAntes, precioAhora);

    const card = document.createElement("div");
    card.className = "card";

    // Imagen + fallback
    const img = new Image();
    img.className = "thumb";
    img.alt = titulo || "Producto";
    img.src = imgUrl || "";
    img.onerror = () => { img.src = FALLBACK_IMG; };
    card.appendChild(img);

    const content = document.createElement("div");
    content.className = "content";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = titulo;

    const bullets = document.createElement("div");
    bullets.className = "bullets";
    const bulletList = bulletsTxt
      .split(/;|\n|‚Ä¢/)
      .map(s => s.trim())
      .filter(Boolean)
      .map(b => "‚Ä¢ " + b)
      .join("<br>");
    bullets.innerHTML = bulletList;

    const price = document.createElement("div");
    price.className = "price";
    if (precioAntes) {
      const before = document.createElement("span");
      before.className = "before";
      before.textContent = precioAntes;
      price.appendChild(before);
    }
    if (precioAhora) {
      const now = document.createElement("span");
      now.className = "now";
      now.innerHTML = precioAhora + (p !== null ? ` <span style="color:#a7f3d0;font-weight:700">(-${p}%)</span>` : "");
      price.appendChild(now);
    }

    const meta = document.createElement("div");
    meta.className = "meta";
    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = (categoria || "").toUpperCase();
    const tags = document.createElement("span");
    tags.style.color = "#a9b0ba";
    tags.style.fontSize = "12px";
    const tagList = (etiquetas || "")
      .split(/[#\s]+/)
      .filter(Boolean)
      .slice(0, 4)
      .map(t => "#" + t)
      .join(" ");
    tags.textContent = tagList;

    meta.appendChild(tag);
    meta.appendChild(tags);

    content.appendChild(title);
    content.appendChild(bullets);
    content.appendChild(price);
    content.appendChild(meta);
    card.appendChild(content);

    // üîò √öNICO BOT√ìN (solo si hay enlace v√°lido)
    if (enlace) {
      const btnRow = document.createElement("div");
      btnRow.style.cssText = "display:flex;gap:10px;align-items:center;padding:0 14px 14px";
      const a1 = document.createElement("a");
      a1.className = "cta";
      a1.href = enlace;               // ‚Üê tu enlace de la hoja tal cual
      a1.target = "_blank";
      a1.rel = "sponsored nofollow";
      a1.textContent = "Ver oferta";
      btnRow.appendChild(a1);
      card.appendChild(btnRow);

      // Log para depurar
      console.log("[SportDeals] href bot√≥n:", a1.href);
    }

    grid.appendChild(card);
  });

  document.getElementById("empty").style.display = rows.length ? "none" : "block";
}

/* Eventos UI */
document.getElementById("q").addEventListener("input", render);
document.getElementById("cat").addEventListener("change", render);
document.getElementById("sort").addEventListener("change", render);

/* üîÅ Auto-refresco cada 5 minutos */
setInterval(load, 5 * 60 * 1000);

/* Primera carga */
load();
</script>

</body>
</html>
