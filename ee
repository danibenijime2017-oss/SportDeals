<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SportDeals | Ofertas fitness</title>
  <meta name="description" content="Las mejores ofertas de deporte: calzado, ropa, suplementos y accesorios." />
  <meta property="og:title" content="SportDeals | Ofertas fitness" />
  <meta property="og:description" content="Chollos de calzado, ropa, suplementos y accesorios deportivos." />
  <meta property="og:type" content="website" />
  <style>
    :root{--bg:#0b0b0c;--card:#141416;--muted:#8a8f98;--text:#f5f6f8;--brand:#6ee7b7;--accent:#60a5fa}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    header{position:sticky;top:0;background:linear-gradient(0deg,transparent,rgba(10,10,12,.9) 40%);backdrop-filter: blur(8px);z-index:10;border-bottom:1px solid #191b1f}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .toolbar{display:grid;grid-template-columns:1fr 160px 180px;gap:10px;align-items:center}
    .brand{display:flex;justify-content:space-between;align-items:center}
    .logo{font-weight:800;font-size:22px;letter-spacing:.2px}
    .links a{color:#a9b0ba;text-decoration:none;margin-left:14px;font-size:14px}
    input,select{background:#0f1012;color:var(--text);border:1px solid #222;outline:none;border-radius:10px;padding:10px 12px}
    main{padding:18px 0 60px}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:960px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid #1f2125;border-radius:18px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;object-fit:cover;width:100%;background:#0f1012}
    .content{padding:14px}
    .title{font-weight:700;line-height:1.2;margin:4px 0 8px;font-size:15px}
    .bullets{color:var(--muted);font-size:13px;line-height:1.45;margin:0 0 10px;min-height:48px}
    .price{display:flex;gap:8px;align-items:baseline;margin:8px 0 12px}
    .before{text-decoration:line-through;color:#a1a1aa;font-size:13px}
    .now{font-weight:800;color:var(--brand);font-size:18px}
    .meta{display:flex;justify-content:space-between;align-items:center;font-size:12px;color:#a9b0ba}
    .tag{background:#0f1012;border:1px solid #202327;border-radius:999px;padding:6px 10px;font-size:12px}
    .cta{display:inline-block;text-align:center;background:var(--accent);color:#06121f;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;text-decoration:none}
    .row-btns{display:flex;gap:10px;align-items:center;padding:0 14px 14px}
    footer{color:#7d8490;font-size:12px;text-align:center;padding:30px 0;border-top:1px solid #191b1f}
    .empty{opacity:.7;text-align:center;padding:40px 10px}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px}
    .modal .box{background:#121316;border:1px solid #2a2d32;border-radius:16px;max-width:720px;width:100%;padding:18px}
    .modal .box h3{margin:0 0 8px}
    .close{float:right;background:#23262b;border:1px solid #2f3338;color:#cbd5e1;border-radius:10px;padding:6px 10px;cursor:pointer}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">üè∑Ô∏è SportDeals</div>
      <div class="links">
        <a href="#" id="openLegal">Aviso de afiliados</a>
        <a href="#" id="refreshBtn" title="Recargar datos">‚Üª Recargar</a>
      </div>
    </div>
    <div class="toolbar" style="margin-top:10px">
      <input id="q" placeholder="Buscar (t√≠tulo, bullets, etiquetas)..." />
      <select id="cat">
        <option value="">Todas las categor√≠as</option>
      </select>
      <select id="sort">
        <option value="fecha-desc">M√°s recientes</option>
        <option value="precio-asc">Precio ahora ‚Üë</option>
        <option value="precio-desc">Precio ahora ‚Üì</option>
        <option value="descuento-desc">Descuento % ‚Üì</option>
      </select>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">No hay resultados. Revisa filtros o que la hoja est√© publicada como CSV.</div>
</main>

<footer>
  <div class="wrap">¬© SportDeals ¬∑ Enlaces de afiliado (<span>#ad</span>) ¬∑ <a href="#" id="openLegal2" style="color:#9bb1ff">Aviso</a></div>
</footer>

<!-- Modal aviso afiliados -->
<div class="modal" id="legalModal" aria-hidden="true">
  <div class="box">
    <button class="close" id="closeLegal">Cerrar</button>
    <h3>Transparencia y enlaces de afiliado</h3>
    <p>Algunos enlaces de esta web son de afiliado (<strong>rel="sponsored nofollow"</strong>). Esto significa que podemos recibir una comisi√≥n si realizas una compra, sin coste extra para ti. Recomendamos solo productos que consideramos relevantes para deporte y fitness.</p>
    <p>Amazon y el logotipo de Amazon son marcas registradas de Amazon.com, Inc. o sus afiliadas. Respetamos las pol√≠ticas de cada anunciante (Amazon, AWIN, etc.).</p>
  </div>
</div>

<script>
/** ‚≠ê Pega aqu√≠ tu URL CSV p√∫blica de Google Sheets ‚≠ê */
const SHEET_CSV = "REEMPLAZA_AQUI_LA_URL_CSV_DE_TU_SHEET";

/* Utilidades */
const csvToRows = (csv) => {
  const lines = csv.split(/\r?\n/).filter(Boolean);
  const headers = lines.shift().split(",").map(h=>h.trim());
  return lines.map(line=>{
    const cells=[]; let cur="", inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i], n=line[i+1];
      if(c==='\"'){ if(inQ && n==='\"'){cur+='\"'; i++;} else inQ=!inQ; }
      else if(c===',' && !inQ){ cells.push(cur); cur=""; }
      else cur+=c;
    }
    cells.push(cur);
    const obj={}; headers.forEach((h,idx)=>obj[h]= (cells[idx]||"").replace(/^\"|\"$/g,""));
    return obj;
  });
};

const qEl = document.getElementById('q');
const catEl = document.getElementById('cat');
const sortEl = document.getElementById('sort');
const grid = document.getElementById('grid');
const empty = document.getElementById('empty');
const refreshBtn = document.getElementById('refreshBtn');

let DATA = [];

function pct(before, now){
  const b=parseFloat((before||"").toString().replace(",","."));
  const n=parseFloat((now||"").toString().replace(",","."));
  if(!isFinite(b)||!isFinite(n)||b<=0) return null;
  return Math.round((1 - n/b)*100);
}

function render(){
  const q=(qEl.value||"").toLowerCase().trim();
  const cat=catEl.value;
  const sort=sortEl.value;

  let rows = DATA.filter(r => (r.Estado||"").toLowerCase()==="listo");

  if(cat) rows = rows.filter(r => (r.Categoria||"").toLowerCase()===cat.toLowerCase());

  if(q){
    rows = rows.filter(r=>{
      const hay = `${r.Titulo} ${r.Bullets} ${r.Etiquetas}`.toLowerCase();
      return hay.includes(q);
    });
  }

  if(sort==="fecha-desc"){
    rows.sort((a,b)=> new Date(b.FechaHora||0)-new Date(a.FechaHora||0));
  }else if(sort==="precio-asc"){
    rows.sort((a,b)=> parseFloat((a.Precio_Ahora||"").replace(",", ".")) - parseFloat((b.Precio_Ahora||"").replace(",", ".")));
  }else if(sort==="precio-desc"){
    rows.sort((a,b)=> parseFloat((b.Precio_Ahora||"").replace(",", ".")) - parseFloat((a.Precio_Ahora||"").replace(",", ".")));
  }else if(sort==="descuento-desc"){
    rows.sort((a,b)=> (pct(b.Precio_Antes,b.Precio_Ahora)||-999) - (pct(a.Precio_Antes,a.Precio_Ahora)||-999));
  }

  grid.innerHTML="";
  if(rows.length===0){ empty.style.display="block"; return } else empty.style.display="none";

  rows.forEach(r=>{
    const p = pct(r.Precio_Antes, r.Precio_Ahora);
    const bullets = (r.Bullets||"").split(/;|\n|‚Ä¢/).map(s=>s.trim()).filter(Boolean).slice(0,4);
    const tags = (r.Etiquetas||"").split(/[#\s]+/).filter(Boolean).slice(0,4);
    const utm = "?utm_source=web&utm_medium=affiliate&utm_campaign=sportdeals";
    const linkAf = (r.Enlace||"").includes("?") ? `${r.Enlace}&${utm.slice(1)}` : `${r.Enlace}${utm}`;

    const card=document.createElement('div');
    card.className="card";
    card.innerHTML=`
      <img class="thumb" loading="lazy" src="${r.Imagen||''}" alt="${(r.Titulo||'Producto')}"
           onerror="this.src='data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 300 225\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'#0f1012\\'/><text x=\\'50%\\' y=\\'50%\\' fill=\\'#384150\\' font-size=\\'16\\' text-anchor=\\'middle\\' dominant-baseline=\\'middle\\'>Imagen no disponible</text></svg>')}'" />
      <div class="content">
        <div class="title">${r.Titulo||''}</div>
        <div class="bullets">${bullets.map(b=>`‚Ä¢ ${b}`).join('<br>')}</div>
        <div class="price">
          ${r.Precio_Antes?`<span class="before">${r.Precio_Antes}</span>`:''}
          ${r.Precio_Ahora?`<span class="now">${r.Precio_Ahora}${p!==null?` <span style="color:#a7f3d0;font-weight:700">(-${p}%)</span>`:''}</span>`:''}
        </div>
        <div class="meta">
          <span class="tag">${(r.Categoria||'').toUpperCase()}</span>
          <span>${tags.length? '#'+tags.join(' #'):''}</span>
        </div>
      </div>
      <div class="row-btns">
        <a class="cta" href="${linkAf}" target="_blank" rel="sponsored nofollow noopener">Ver oferta</a>
        <a class="cta" style="background:#22d3ee" href="${r.Enlace||'#'}" target="_blank" rel="sponsored nofollow noopener">Link limpio</a>
      </div>
    `;
    grid.appendChild(card);
  });
}

async function load(){
  try{
    const res = await fetch(https://docs.google.com/spreadsheets/d/e/2PACX-1vT1KsfcN4AUSWQOzFBdhzbmswKeDvQ4YQji_0uCYMMo7IBAchfKb8l6cGEfe-a6GZJzJmJqa_3Q1lyo/pubhtml?gid=1588859322&single=true, {cache:"no-store"});
    const csv = await res.text();
    DATA = csvToRows(csv);
    // categor√≠as
    const cats = [...new Set(DATA.map(r=>(r.Categoria||'').trim()).filter(Boolean))].sort();
    catEl.innerHTML = '<option value="">Todas las categor√≠as</option>';
    cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; catEl.appendChild(o); });
    render();
  }catch(e){
    grid.innerHTML = "<div class='empty'>No pude leer el CSV p√∫blico de tu hoja. Revisa el enlace de publicaci√≥n.</div>";
  }
}

qEl.addEventListener('input', render);
catEl.addEventListener('change', render);
sortEl.addEventListener('change', render);
refreshBtn.addEventListener('click', (e)=>{ e.preventDefault(); load(); });

/* Modal aviso afiliados */
const modal = document.getElementById('legalModal');
document.getElementById('openLegal').onclick = document.getElementById('openLegal2').onclick = (e)=>{ e.preventDefault(); modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); };
document.getElementById('closeLegal').onclick = ()=>{ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); };
modal.addEventListener('click', (e)=>{ if(e.target===modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); } });

load();
</script>
</body>
</html>
